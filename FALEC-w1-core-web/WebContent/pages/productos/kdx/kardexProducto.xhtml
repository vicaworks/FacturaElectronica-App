<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:o="http://omnifaces.org/ui"
				xmlns:of="http://omnifaces.org/functions"
                template="/WEB-INF/template/templateV2.xhtml">

    <ui:define name="title">Kardex</ui:define>
    
    <ui:define name="head">
        <style type="text/css">
			
			.kardexDT .ui-datatable-scrollable-body{
				height: calc(100vh - 255px)!important;
			}
			
        </style>
    </ui:define>

    <ui:define name="content">
    
    	<!-- CONSTANTES -->
    	<o:importConstants type="com.vcw.falecpv.core.constante.EstadoRegistroEnum" var="EstadoRegistroEnum" />
    
    	<p:breadCrumb>
		    <p:menuitem url="#{request.contextPath}/pages/main.jsf" />
		    <p:menuitem value="Productos" url="#{request.contextPath}/pages/productos/producto.jsf" />
		    <p:menuitem value="Kardex producto" url="#{request.contextPath}/pages/productos/kdx/kardexProducto.jsf"/>
		</p:breadCrumb>
		
		
		<!-- OPCIONES -->
	    <h:form id="formMain">
	    	
	    	<div class="card h-full">		                
				<div class="flex justify-content-between align-items-baseline">
					<h3 class="card__heading card__heading--noBorder fw-4">Kardex</h3>
					<div class="flex justify-content-end" style="gap: .4rem;">							
		                <p:selectOneMenu id="somEstablecimientoMain"
							value="#{kardexCtrl.establecimientoMain}"
							converter="omnifaces.SelectItemsConverter"
							style="text-overflow: hidden!important;max-width:200px!important;min-width:200px!important"
							disabled="#{not kardexCtrl.habilitarEstablecimientoMain}">
							
							<f:selectItems value="#{kardexCtrl.establecimientoMainList}" var="st"
								itemLabel="#{appSessionCtrl.formatoCadena(st.codigoestablecimiento,3,'0').concat(' - ').concat(st.nombrecomercial)}" itemValue="#{st}" />							
							<p:ajax event="valueChange" listener="#{kardexCtrl.limpiar()}" update="@form"/> 								
						</p:selectOneMenu>
					</div>
				</div>
				
				<div class="grid ui-fluid main__opciones px-2 mt-1">
					<div class="col-12 md:col-4">
						<div class="field">
							<label class="text-gray-800 fw-6">Fechas</label>
							<div class="flex gap-2">
								<p:calendar id="claKardexFechaDesde" value="#{kardexCtrl.fechaInicial}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true">
								</p:calendar>
								<p:calendar id="claKardexFechaHasta" value="#{kardexCtrl.fechaFinal}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true">
								</p:calendar>
							</div>
						</div>
					</div>
					<div class="col-12 md:col-6">
						<div class="field">
							<label class="text-gray-800 fw-6">Producto</label>
							<p:selectOneMenu id="somFrmListaProducto"
										value="#{kardexCtrl.productoSelected}"
										converter="omnifaces.SelectItemsConverter"
										required="false"
										requiredMessage="Requerido"
										styleClass="overflow-x-hidden"
										style="width: calc(100% - .01rem); margin-top:.2rem;"
										filter="true" 
										filterMatchMode="contains">
								<f:selectItem itemLabel="Seleccionar Producto  "
										itemValue="#{null}" value="#{null}" noSelectionOption="true" />
								<f:selectItems value="#{kardexCtrl.productoList}" var="prof"
									itemLabel="#{prof.nombregenerico}" itemValue="#{prof}" />
								<p:ajax event="change" listener="#{kardexCtrl.cambioProducto}"></p:ajax>
							</p:selectOneMenu>
						</div>
					</div>
					
					<div class="col-12 md:col-2">
						<div class="field">
							<label class="text-gray-800 fw-6">Código</label>
							<p:inputText id="intCodProducto" 
								value="#{kardexCtrl.codProducto}" 
								required="false" 
								requiredMessage="Requerido" 
								styleClass="w-full" />
						</div>
					</div>
					
				</div>
				
				<div class="flex justify-content-between my-2">
					<div class="flex gap-2">
						<p:commandButton id="cmdRefrecar"
								title="Consultar" icon="fa fa-search" value="Buscar" 
								action="#{kardexCtrl.refrescar()}" 
								styleClass="min-width-70 ui-button-success" update="@form"/>
						<p:commandButton id="cmdKarEntrada"
								icon="fa-solid fa-plus" value="Entrada"
								styleClass="min-width-70 ui-button-secondary ui-button-outlined" 
								action="#{kardexCtrl.nuevo()}"
								disabled="#{kardexCtrl.productoSelected==null}">
								<f:setPropertyActionListener value="E" target="#{kardexCtrl.tipoRegistro}"/>
								<f:setPropertyActionListener value="KARDEX" target="#{kardexCtrl.callMOdule}"/>
								<f:setPropertyActionListener value=":formMain" target="#{kardexCtrl.updateView}"/>
								<f:setPropertyActionListener value="frmKardex" target="#{kardexCtrl.formView}"/>
						</p:commandButton>
						<p:commandButton id="cmdKarSalida"
								icon="fa-solid fa-minus" value="Salida"
								styleClass="min-width-70 ui-button-secondary ui-button-outlined" 
								action="#{kardexCtrl.nuevo()}"
								disabled="#{kardexCtrl.productoSelected==null}">
								<f:setPropertyActionListener value="S" target="#{kardexCtrl.tipoRegistro}"/>
								<f:setPropertyActionListener value="KARDEX" target="#{kardexCtrl.callMOdule}"/>
								<f:setPropertyActionListener value=":formMain" target="#{kardexCtrl.updateView}"/>
								<f:setPropertyActionListener value="frmKardexSalida" target="#{kardexCtrl.formView}"/>
						</p:commandButton>
					</div>
					<div class="flex align-items-end gap-2">
						<i class="fa fa-ellipsis-v fs-14"/>					
						<p:commandLink id="cmdGlobalExcel">
							<div class="flex align-items-center gap-1">
								<span class="text-gray-900 fs-12">Exportar</span>
								<i class="fa fa-angle-down fs-16 text-gray-900" />
							</div>
						</p:commandLink>
						<p:menu overlay="true" trigger="cmdGlobalExcel" my="left top" at="left bottom" style="width:250px !important;">
							<p:menuitem value="Exportar producto" icon="fa fa-download" ajax="false" onclick="PrimeFaces.monitorDownload(start,stop)"
								disabled="#{kardexCtrl.kardexProductoList==null or empty kardexCtrl.kardexProductoList}">
								<p:fileDownload value="#{kardexCtrl.fileKardex}"/>											
							</p:menuitem>
							<p:menuitem value="Exportar todos los productos" icon="fa fa-download" ajax="false" onclick="PrimeFaces.monitorDownload(start,stop)">
								<p:fileDownload value="#{kardexCtrl.fileKardexAll}"/>											
							</p:menuitem>
						</p:menu>	
						
					</div>
				</div>
				
				<p:dataTable id="kardexDT" var="k"
					value="#{kardexCtrl.kardexProductoList}" scrollable="true"
					emptyMessage="#{msg['mensaje.noexistenDatos']}"
					styleClass="kardexDT fs-11"  
					rowKey="#{k.idkardexproducto}"
					paginator="true"
	                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
	                currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
	                paginatorPosition="bottom"  
					rows="10"
					rowsPerPageTemplate="10,15,20,25,30,35,40">
	                
	                <p:column headerText="Fechas" style="width:14rem;">
	                	<div class="flex flex-column gap-1">
	                		<div class="flex gap-2 align-items-baseline">
		                		<small class="min-width-70">Registro</small>
								<h:outputText value="#{k.updated}" styleClass="text-gray-900">
									<f:convertDateTime  pattern="dd/MM/yyyy HH:mm"/>
								</h:outputText>
	                		</div>
							
							<div class="flex gap-2 align-items-baseline">
								<small class="min-width-70">Compra</small>
								<h:outputText value="#{k.fechacompra}" styleClass="text-primary-700">
									<f:convertDateTime  pattern="dd/MM/yyyy"/>
								</h:outputText>
							</div>
							
							<div class="flex gap-2 align-items-baseline">
								<small class="min-width-70">Fabricación</small>
								<h:outputText value="#{k.fechafabricacion != null ? k.fechafabricacion : '-'}"
									styleClass="text-gray-900">
									<f:convertDateTime  pattern="dd/MM/yyyy" />
								</h:outputText>
							</div>
							
							<div class="flex gap-2 align-items-baseline">
								<small class="min-width-70">Vencimiento</small>
								<h:outputText value="#{k.fechavencimiento != null ? k.fechavencimiento : '-'}"
									styleClass="text-gray-900">
									<f:convertDateTime  pattern="dd/MM/yyyy"/>
								</h:outputText>
							</div>
						</div>					
					</p:column>
					
					<p:column headerText="#{msg['label.descripcion']}" style="width:20rem;">
						<h:outputText value="#{k.observacion}" styleClass="block mr-1">
						</h:outputText>
					</p:column>
					
					<p:column headerText="Cantidad" style="width:16rem;">
						
						<div class="flex gap-2 pr-2">
							<div class="flex-1">
								<small class="block mb-1">Fecha inventario</small>
								<h:outputText value="#{k.fecharegistro}"
									styleClass="text-primary-700">
									<f:convertDateTime  pattern="dd/MM/yyyy" />
								</h:outputText>
							</div>
							<div class="flex-1 flex gap-2 justify-content-end align-items-center">
								<h:outputText value="#{k.cantidad}" styleClass="fs-16 text-gray-900 fw-5">
									<f:convertNumber  pattern="#{appSessionCtrl.formatoNumberDecimalOpcional}"/>
								</h:outputText>
								<p:avatar label="#{k.tiporegistro}" styleClass="#{k.tiporegistro == 'E' ? 'bg-green-700' :  'bg-pink-500'} fw-6 fs-14" style="color:#fff;" shape="circle"  />
								<!-- <i class="fs-18 #{k.tiporegistro=='E' ? 'pi pi-plus-circle fs-20 text-green-700' : 'pi pi-minus-circle fs-20 text-pink-400'}"></i> -->								
							</div>
						</div>
						<div class="flex gap-2 pr-2">
							<div class="flex-1">
								<small class="block mb-1">Precio compra</small>
								<h:outputText value="#{k.costounitario}" styleClass="fs-12 text-gray-900">
									<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
								</h:outputText>		
							</div>
							<div class="flex-1">
								<div class="text-center">
									<small class="block mb-1">Precio total</small>
									<h:outputText value="#{k.costototal}" styleClass="fs-12 text-gray-900">
										<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
									</h:outputText>		
								</div>
							</div>
						</div>
					</p:column>
					
					<p:column headerText="Existencia" style="width:6rem;">
						<div class="flex justify-content-end pr-2 mt-1">
							<h:outputText value="#{k.saldo}" styleClass="fs-16 fw-5 #{kardexCtrl.getCompararValoresDouble(k.saldo.doubleValue(),0) ? 'text-pink-500' : 'text-gray-900'}">
								<f:convertNumber  pattern="#{appSessionCtrl.formatoNumberDecimalOpcional}"/>
							</h:outputText>
						</div>
					</p:column>
	                
	                <p:column headerText="Precio de venta" style="width:9rem;">						
						<div class="flex flex-column gap-1 fs-12">
							<div class="flex justify-content-end gap-1 align-items-baseline">
								<h:outputText value="#{k.producto.preciouno}" styleClass="#{k.producto.preciouno > 0 ? 'text-primary-600 fw-5' : 'text-primary-300'}">
									<f:convertNumber  pattern="#{appSessionCtrl.formatoMoneda}"/>
								</h:outputText>
								<h:outputText value="pv-1" styleClass="fs-10"/>								
							</div>
							<div class="flex justify-content-end gap-1 align-items-baseline">
								<h:outputText value="#{k.producto.preciodos}" styleClass="#{k.producto.preciodos > 0 ? 'text-gray-800' : 'text-gray-300'}">
									<f:convertNumber  pattern="#{appSessionCtrl.formatoMoneda}"/>
								</h:outputText>								
								<h:outputText value="pv-2" styleClass="fs-10"/>
							</div>
							<div class="flex justify-content-end gap-1 align-items-baseline">
								<h:outputText value="#{k.producto.preciotres}" styleClass="#{k.producto.preciotres > 0 ? 'text-gray-800' : 'text-gray-300'}">
									<f:convertNumber  pattern="#{appSessionCtrl.formatoMoneda}"/>
								</h:outputText>
								<h:outputText value="pv-3" styleClass="fs-10"/>
							</div>
						</div>	
					</p:column>
	                
	                
				</p:dataTable>
			</div>
	    	
	    </h:form>
	    
	    <!-- Form Entrada -->
	    <ui:include src="incl_kardex_entrada_form.xhtml" />
	    
	    <!-- Form Salida -->
	    <ui:include src="incl_kardex_salida_form.xhtml" />
        
    </ui:define>

</ui:composition>
