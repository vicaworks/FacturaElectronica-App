<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:o="http://omnifaces.org/ui"
				xmlns:of="http://omnifaces.org/functions"
                template="/WEB-INF/template/templateV2.xhtml">

    <ui:define name="title">Compras</ui:define>
    
    <ui:define name="head">
        <style type="text/css">
			
			.adquisicionDT .ui-datatable-scrollable-body{
				min-height: 40vh !important;
				height: calc(100vh - 270px);
				
			}
			
        </style>
    </ui:define>

    <ui:define name="content">
    
    	<!-- CONSTANTES -->
    	<o:importConstants type="com.vcw.falecpv.core.constante.EstadoRegistroEnum" var="EstadoRegistroEnum" />
    	<o:importConstants type="com.vcw.falecpv.core.constante.ComprobanteEstadoEnum" var="ComprobanteEstadoEnum" />
    	
    
    	<p:breadCrumb>
		    <p:menuitem url="#{request.contextPath}/pages/main.jsf" />
		    <p:menuitem value="Lista de compras" url="#{request.contextPath}/pages/adquisicion/adquisicion.jsf"/>
		</p:breadCrumb>
		
	    <h:form id="formMain">
	    	
			
			<div class="card mt-1">              
				<div class="flex justify-content-between align-items-baseline">
					<h3 class="card__heading card__heading--noBorder fw-4">Compras</h3>
					<div class="flex justify-content-end" style="gap: .4rem;">
						<p:selectOneMenu id="somEstablecimientoMain"
							value="#{adquisicionMainCtrl.establecimientoMain}"
							converter="omnifaces.SelectItemsConverter"
							style="text-overflow: hidden!important;max-width:200px!important;min-width:200px!important"
							disabled="#{not adquisicionMainCtrl.habilitarEstablecimientoMain}">
							
							<f:selectItems value="#{adquisicionMainCtrl.establecimientoMainList}" var="st"
								itemLabel="#{st.nombrecomercial.concat(' - ').concat(appSessionCtrl.formatoCadena(st.codigoestablecimiento,3,'0'))}" itemValue="#{st}" />
							
							<p:ajax event="valueChange" listener="#{adquisicionMainCtrl.refrescar()}" update="@form"/>
								
						</p:selectOneMenu>
					</div>
				</div>
				
				<div class="grid ui-fluid main__opciones px-2">
					<div class="col-12 md:col-2">
						<div class="field">
							<label class="text-gray-800">Estado</label>
							<p:selectOneMenu  value="#{adquisicionMainCtrl.estado}" 
								 styleClass="overflow-x-hidden"
								 style="width: calc(100% - 0.1rem)" 
								 required="false" requiredMessage="Requerido">
								<f:selectItem itemLabel="TODOS" itemValue="#{null}" />			 
								<f:selectItem itemLabel="ACTIVO" itemValue="A" />
								<f:selectItem itemLabel="ANULADO" itemValue="I" />
							</p:selectOneMenu>
						</div>
					</div>
					
					<div class="col-12 md:col-3">
						<div class="field">
							<label class="text-gray-800">Fechas</label>
							<div class="flex gap-2">
								<p:calendar id="calDesde" value="#{adquisicionMainCtrl.desde}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true" placeholder="dd/MM/yyyy">
								</p:calendar>
								<p:calendar id="calHasta" value="#{adquisicionMainCtrl.hasta}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true" placeholder="dd/MM/yyyy">
								</p:calendar>
								
							</div>
						</div>
					</div>
					
					<div class="col-12 md:col-4">
						<div class="field">
							<label class="text-gray-800">Criterio de búsqueda</label>
							<p:inputText value="#{adquisicionMainCtrl.criterioBusqueda}" placeholder="Proveedor, Ruc, Num. Factura"/>
						</div>
					</div>
					
					<div class="mt-2 col-12 md:col-3 md:mt-0">
						<div class="inline-flex gap-2 h-full align-items-end">
							<p:commandButton id="cmdAdqRefrecar"
								title="Consultar" icon="fa fa-search" value="Buscar" 
								action="#{adquisicionMainCtrl.refrescar()}" styleClass="ui-button-outlined" update="@form"
							/>	   				
		   					<p:commandButton id="cmdAdqNuevo"
								title="Nueva compra" icon="fa fa-plus" value="Nuevo"
								action="#{adquisicionMainCtrl.nuevaCompra()}" styleClass="#{appSessionCtrl.accesoDisable('mn_compras_admin')?'ui-state-disabled':''} ui-button-success" update="@form">
								<f:setPropertyActionListener value="#{adquisicionMainCtrl.establecimientoMain}" target="#{adquisicionFrmCtrl.establecimientoMain}"/>
		   					</p:commandButton>
						</div>
					</div>
					
				</div><!-- Fin de las opciones -->
				
				<div class="flex my-2 align-items-center gap-2">
					<i class="fa fa-ellipsis-v fs-14"/>
					<p:commandLink id="cmdGlobalExcel" disabled="#{empty adquisicionMainCtrl.adquisicionList}" styleClass="min-width-80">
						<div class="flex gap-1">
							<span class="text-gray-900 fs-12">Exportar</span>
							<i class="fa fa-angle-down fs-14 text-gray-900" />
						</div>
					</p:commandLink>
					
					<p:menu overlay="true" trigger="cmdGlobalExcel" my="left top" at="left bottom" style="width:250px !important;">
						<p:menuitem value="Exportar excel" icon="fa-regular fa-file-excel fs-14" ajax="false">
							<p:fileDownload value="#{adquisicionMainCtrl.fileCompras}" contentDisposition="inline"/>
						</p:menuitem>
						<p:menuitem value="Exportar excel / detalle" icon="fa fa-list fs-14" ajax="false">
							<p:fileDownload value="#{adquisicionMainCtrl.fileComprasDet}" contentDisposition="inline"/>
						</p:menuitem>
					</p:menu>
				</div><!-- Submenu de opciones -->
				
				<p:dataTable id="adquisicionDT" var="a"
					value="#{adquisicionMainCtrl.adquisicionList}" scrollable="true"
					emptyMessage="#{msg['mensaje.noexistenDatos']}"
					styleClass="adquisicionDT mt-1"  
					rowKey="#{a.idadquisicion}"
					paginator="true"
					paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
	                currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
	                paginatorPosition="bottom"  
					rows="15"
					rowsPerPageTemplate="15,20,25,30,35,40">
					
					<p:column headerText="Opc" style="width:20px;">
						
						<p:commandLink id="cmlDtCompra">
							<i class="fa fa-chevron-circle-down fs-18 text-gray-800" />
						</p:commandLink>
						
						
						<p:menu overlay="true" trigger="cmlDtCompra" my="left top" at="left bottom">							
							<p:menuitem value="Editar" action="#{adquisicionMainCtrl.editarCompra(a.idadquisicion)}" icon="fa fa-edit fs-14" disabled="#{a.estado=='ANULADO'}" styleClass="#{appSessionCtrl.accesoDisable('mn_compras_admin')?'ui-state-disabled':''}">
								<f:setPropertyActionListener value="#{adquisicionMainCtrl.establecimientoMain}" target="#{adquisicionFrmCtrl.establecimientoMain}"/>
							</p:menuitem>
							<p:menuitem value="#{msg['label.retencion2']}" action="#{retencionMainCtrl.nuevaRetencion()}" icon="fa fa-plus  fs-14" disabled="#{a.estado=='ANULADO'}" styleClass="#{appSessionCtrl.accesoDisable('mn_compras_admin')?'ui-state-disabled':''}">
								<f:setPropertyActionListener value="#{adquisicionMainCtrl.establecimientoMain}" target="#{retencionFrmCtrl.establecimientoMain}"/>
								<f:setPropertyActionListener value="#{a}" target="#{retencionFrmCtrl.adquisicionSelected}"/>
								<f:setPropertyActionListener value="ADQUISICION" target="#{retencionFrmCtrl.callModule}"/>
								<f:setPropertyActionListener value=":formMain" target="#{retencionFrmCtrl.viewUpdate}"/>
								<f:setPropertyActionListener value="#{retencionFrmCtrl}" target="#{retencionMainCtrl.retencionFormCtrl}"/>
								<f:setPropertyActionListener value="#{retencionMainCtrl}" target="#{retencionFrmCtrl.retencionMainCtrl}"/>
							</p:menuitem>
							<p:menuitem value="Anular" action="#{adquisicionMainCtrl.anular(a.idadquisicion)}" icon="fa-regular fa-trash-can fs-14" disabled="#{a.estado=='ANULADO'}" styleClass="#{appSessionCtrl.accesoDisable('mn_compras_admin')?'ui-state-disabled':''}" update="@form">
								<p:confirm header="#{msg['label.confirmacion']}" message="#{msg['mensaje.confimacion']}" icon="fa fw-3x fa-exclamation-triangle" />
							</p:menuitem>
						</p:menu>
						
					</p:column>
					
					<p:column headerText="Factura de compra" style="width:120px;" filterBy="#{a.numfactura}" filterMatchMode="contains">
						
						<div class="flex flex-column gap-1">
							<h:outputText value="#{a.fecha}" styleClass="text-gray-900 font-semibold">
								<f:convertDateTime pattern="dd/MM/yyyy"/>
							</h:outputText>	
							<h:outputText value="#{facEmitidaCtrl.getFormatoNumDocumento(a.numfactura)}"/>							
						</div>
						
					</p:column>
					
					
					<p:column style="width:180px;" filterBy="#{a.cliente.filterRazonSocial}" filterMatchMode="contains" headerText="Proveedor">
						
						<div class="flex flex-column gap-1">
								<h:outputText value="#{a.cliente.identificacion}" styleClass="fs-11 text-gray-900"/>
								<h:outputText value="#{a.cliente.razonsocial}" styleClass="text-gray-900 fw-5">
								</h:outputText>
							</div>
					</p:column>
					
					<p:column headerText="Estado" style="width:60px;">
						<h:outputText value="#{a.estado}" styleClass="#{a.style} p-1 border-round block w-full text-center">
						</h:outputText>
					</p:column>
					
					<p:column headerText="Gasto" style="width:2.5rem;" styleClass="text-center">
						<f:subview rendered="#{a.esgasto==1}">
							<i class="fa fa-check fs-14" style="color:black;"/>
						</f:subview>
						<f:subview rendered="#{a.esgasto==0}">
							<i class="fa fa-minus fs-14" style="color:#ccc;"/>
						</f:subview>
					</p:column>
										
					
					<p:column headerText="Sin impuestos" style="width:80px;" styleClass="text-center">
						<div class="flex justify-content-end">
							<h:outputText value="#{a.subtotal}" >
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="Descuento" style="width:80px;" styleClass="text-center">
						<div class="flex justify-content-end">
							<h:outputText value="#{a.totaldescuento}" styleClass="#{a.totaldescuento>0?'text-gray-600':' opacity-50'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="Impuestos" style="width:10rem;" styleClass="text-center">
						
						<div class="flex justify-content-end gap-1 align-items-baseline">
							<h:outputText value="#{a.totalice}"  styleClass="fs-10 #{a.totalice.doubleValue()==0.0?'opacity-70':'text-gray-900'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
							<span class="fs-9 text-gray-700">ICE</span>
						</div>
						
						<div class="flex justify-content-end gap-1 align-items-baseline">
							<h:outputText value="#{a.totaliva}"  styleClass="fs-10 #{a.totaliva.doubleValue()==0.0?'opacity-70':'text-gray-900'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
							<span class="fs-9 text-gray-700">IVA</span>
						</div>
						
						
					</p:column>
					
					<p:column headerText="Total" style="width:80px;" styleClass="text-center">
						<div class="flex justify-content-end">
							<h:outputText value="#{a.totalfactura}" styleClass="text-gray-800 font-medium">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="A pagar" style="width:120px;" styleClass="text-center pl-2">
							
						<div class="flex justify-content-between">
							<span class="fs-10 text-gray-700">Retención</span>
							<h:outputText value="#{a.totalretencion}" styleClass="fs-10 #{a.totalretencion.doubleValue()==0.0?'opacity-70':'text-gray-900'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
						
						<div class="flex justify-content-between">
							<span class="fs-10 text-gray-700">A pagar</span>
							<h:outputText value="#{a.totalpagar}" styleClass="#{a.totalpagar.doubleValue()==0.0?'opacity-70':'text-gray-900'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
						
						<div class="flex justify-content-between">
							<div class="flex gap-2">
								<p:commandLink action="#{pagoCtrl.cargarPagosAdquisicionById()}" process="@this">
									<i class="fa fa-eye text-primary-600 font-semibold fs-12"/>
									<f:setPropertyActionListener value="#{a.idadquisicion}" target="#{pagoCtrl.idComprobante}"/>
									<f:setPropertyActionListener value="#{a.totalpagar}" target="#{pagoCtrl.valorPagar}"/>
								</p:commandLink>
								<span class="fs-10 text-gray-700">Pago</span>
							</div>
							<p:commandLink action="#{pagoCtrl.cargarPagosAdquisicionById()}" process="@this">
								<h:outputText value="#{a.totalpagar}" styleClass="fs-11 #{a.totalpagar.doubleValue()!=a.totalpagar.doubleValue() and a.estado!='ANULADO' ?'text-gray-900':'text-primary-600 font-semibold'}">
									<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
								</h:outputText>
								<f:setPropertyActionListener value="#{a.idadquisicion}" target="#{pagoCtrl.idComprobante}"/>
								<f:setPropertyActionListener value="#{a.totalpagar}" target="#{pagoCtrl.valorPagar}"/>
							</p:commandLink>
						</div>
						
					</p:column>
					
					
					
					<!-- <p:column headerText="#{msg['label.retencion']}" style="width:60px;" styleClass="TexAlRight">
						<h:outputText value="#{a.totalretencion}" styleClass="#{a.totalretencion>0?'text-gray-600':' opacity-50'}">
							<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
						</h:outputText>
					</p:column>
					
					<p:column headerText="A PAGAR" style="width:90px;" styleClass="TexAlRight">
						<div class="flex flex-inline justify-content-end">
							<h:outputText value="#{a.totalpagar}" styleClass="#{a.totalpagar.doubleValue()!=a.totalPagoSum.doubleValue()?'text-pink-400':'text-gray-800'} font-bold mr-1" style="width:75px;">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
							<p:commandLink action="#{pagoCtrl.cargarPagosAdquisicionById()}" process="@this" disabled="#{a.estado=='ANULADO'}">
								<i class="fa fa-external-link text-gray-900"/>
								<f:setPropertyActionListener value="#{a.idadquisicion}" target="#{pagoCtrl.idComprobante}"/>
								<f:setPropertyActionListener value="#{a.totalpagar}" target="#{pagoCtrl.valorPagar}"/>
							</p:commandLink>
						</div>
					</p:column> -->
					
				</p:dataTable>
				
			</div>
			
			
	    </h:form>
	    <!-- Lisdao de pago -->
	    <ui:include src="../common/incl_comprobante_pagos.xhtml" />
        
    </ui:define>

</ui:composition>
