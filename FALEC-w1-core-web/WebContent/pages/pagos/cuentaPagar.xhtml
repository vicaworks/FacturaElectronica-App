<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:o="http://omnifaces.org/ui"
				xmlns:of="http://omnifaces.org/functions"
                template="/WEB-INF/template/templateV2.xhtml">

    <ui:define name="title">Cuentas Pagar</ui:define>
    
    <ui:define name="head">
        <style type="text/css">
        
        	.pvUnoDT .ui-datatable-scrollable-body{
				min-height: 40vh !important;
				height: calc(100vh - 380px)!important;				
			}
						
        </style>
    </ui:define>

    <ui:define name="content">
    
    	<!-- CONSTANTES -->
    	<o:importConstants type="com.vcw.falecpv.core.constante.EstadoRegistroEnum" var="EstadoRegistroEnum" />
    	
    	
    	<p:breadCrumb>
		    <p:menuitem url="#{request.contextPath}/pages/main.jsf" />
		    <p:menuitem value="Pagos menú" url="#{request.contextPath}/pages/pagos/pagos.jsf"/>
		    <p:menuitem value="Compras" url="#{request.contextPath}/pages/adquisicion/adquisicion.jsf"/>
		</p:breadCrumb>
    	
    	<!-- Reporte global -->
	    <h:form id="formMain">
		   	
		   	
		   	<div class="card mt-1">
		   	              
				<div class="flex justify-content-between align-items-baseline">
					<h3 class="card__heading card__heading--noBorder fw-4">Cuentas x pagar</h3>
					<div class="flex justify-content-end" style="gap: .4rem;">
						
						<p:selectOneMenu id="somEstablecimientoMain"
							value="#{cuentaPagarCtrl.establecimientoMain}"
							converter="omnifaces.SelectItemsConverter"
							style="text-overflow: hidden!important;max-width:200px!important;min-width:200px!important"
							disabled="#{not cuentaPagarCtrl.habilitarEstablecimientoMain}">
							
							<f:selectItems value="#{cuentaPagarCtrl.establecimientoMainList}" var="st"
								itemLabel="#{appSessionCtrl.formatoCadena(st.codigoestablecimiento,3,'0').concat(' - ').concat(st.nombrecomercial)}" itemValue="#{st}" />
							
							<p:ajax event="valueChange" listener="#{cuentaPagarCtrl.buscar()}" update="@form"/>
								
						</p:selectOneMenu>
						
					</div>
				</div>
				
				<p:outputPanel id="oupOpcBusqueda" class="grid ui-fluid main__opciones px-2 mt-2">
					
					<div class="col-12 md:col-4">
						<div class="flex gap-1">
							<div class="flex-1 field">
								<label class="text-gray-800">Opción de consulta</label>
	   							<p:selectOneMenu id="somTipoPago"
									value="#{cuentaPagarCtrl.idTipocomprobante}"
									converter="omnifaces.SelectItemsConverter"
									required="false"
									requiredMessage="Requerido"
									styleClass="w-full">
									<f:selectItem itemLabel="Cuentas por pagar activas" itemValue="T"/>
									<f:selectItem itemLabel="Compras por pagar" itemValue="C"/>
									<f:selectItem itemLabel="#{msg['label.liquidacion']} de compra por pagar" itemValue="L"/>	
									<f:selectItem itemLabel="Consulta de historial de pagos" itemValue="H"/>
									<p:ajax listener="#{cuentaPagarCtrl.seleccionarOpcion}" process="@this @form:somTipoPago" update="@form:oupOpcBusqueda"/>
								</p:selectOneMenu>									
								
							</div>
							<div class="flex-1 field">
								<label class="text-gray-800">Número de comprobante</label>
								<p:inputMask id="inpRtnNumFac" value="#{cuentaPagarCtrl.criterioBusqueda}" mask="999-999-999999999" required="false" requiredMessage="REQUERIDO" styleClass="w-full" maxlength="17" validatorMessage="FORMATO 999-999-999999999" placeholder="FORMATO : 999-999-999999999">
									<f:converter converterId="formatoNumComprobanteConverter"/>
								</p:inputMask>
							</div>
						</div>
					</div>
					
					<div class="col-12 md:col-3">
						<div class="field">
							<label class="#{cuentaPagarCtrl.idTipocomprobante == 'H' ? 'text-gray-800' : 'opacity-50'}">Fechas</label>
							<div class="flex gap-1">
								<p:calendar id="calRep1" value="#{cuentaPagarCtrl.desde}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true" placeholder="dd/MM/yyyy"
									disabled="#{cuentaPagarCtrl.idTipocomprobante != 'H'}">
								</p:calendar>
								<p:calendar id="calRep2" value="#{cuentaPagarCtrl.hasta}"
									pattern="dd/MM/yyyy"
									locale="es" 
									requiredMessage="Requerido" required="true" placeholder="dd/MM/yyyy"
									disabled="#{cuentaPagarCtrl.idTipocomprobante != 'H'}">
								</p:calendar>
								
							</div>
						</div>
					</div>
					
					<div class="col-12 md:col-3">
						<div class="field">
							<label class="text-gray-800">Proveedor</label>
							<div class="ui-inputgroup">
			                    <p:commandButton icon="pi pi-search" styleClass="ui-button-success" 
			                    	process="@this :formMain:inpCriterioCliente"
									action="#{listaClienteCtrl.cargarPantalla()}" 
									immediate="true">
									<f:setPropertyActionListener value="#{cuentaPagarCtrl}" target="#{listaClienteCtrl.cuentaPagarCtrl}"/>
									<f:setPropertyActionListener value="cuentaPagarCtrl" target="#{listaClienteCtrl.callModule}"/>
									<f:setPropertyActionListener value=":formMain" target="#{listaClienteCtrl.viewUpdate}"/>
									<f:setPropertyActionListener value="formMain" target="#{listaClienteCtrl.formModule}"/>
								</p:commandButton> 
			                    <p:inputText id="inpCriterioCliente"
										value="#{cuentaPagarCtrl.criterioCliente}" required="false"
										requiredMessage="Requerido"
										maxlength="13" 
										placeholder="Identificación CI, RUC"
										validatorMessage="Solo números"
										onkeydown="if(event.keyCode==13){event.keyCode=123;return false;}">
									<f:validateRegex pattern="^\d+$" />
								</p:inputText>
			                </div>		
						</div>
					</div>
					
					<div class="mt-2 col-12 md:col-2 md:mt-0">
						<div class="inline-flex gap-2 h-full align-items-end">
							<p:commandButton id="cmdGlobalBuscar"
								icon="fa fa-search" 
								value="Buscar"
								action="#{cuentaPagarCtrl.buscar()}" 
								styleClass="ui-button-success" 
								update="@form" 
								title="Buscar"/>							
						</div>
					</div>
					
				</p:outputPanel>
				
				<div class="contenedor">
		    		<div class="cards_resumen_grid">
			            <div class="card_resumen_f1 card_resumen_f1--red">
			                <div class="card_resumen_f1__aside">
			                    <i class="fa-solid fa-circle-minus"></i>
			                </div>
			                <div class="card_resumen_f1__content">
			                    <div class="card_resumen_f1__value">
			                        <h:outputText value="#{cuentaPagarCtrl.totalVencido}">
										<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
									</h:outputText>
			                    </div>
			                    <div class="card_resumen_f1__footer">
			                        Total<span>VENCIDO</span>
			                    </div>
			                </div>
			            </div>
			
			            <div class="card_resumen_f1 card_resumen_f1--primary">
			                <div class="card_resumen_f1__aside">
			                    <i class="fa-brands fa-paypal"></i>
			                </div>
			                <div class="card_resumen_f1__content">
			                    <div class="card_resumen_f1__value">
			                        <h:outputText value="#{cuentaPagarCtrl.totalPagar}">
										<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
									</h:outputText>
			                    </div>
			                    <div class="card_resumen_f1__footer">
			                        Total <span>POR PAGAR</span>
			                    </div>
			                </div>
			            </div>
			
			        </div>
	    		</div>
	    		
	    		<div class="flex align-items-center gap-1">
					<i class="fa fa-ellipsis-v fs-14 mr-2"/>
					<p:commandLink id="cmdGlobalExcel" disabled="#{empty cuentaPagarCtrl.vComprobantespagarcreditoList}" styleClass="min-width-80">
						<div class="flex text-gray-900 gap-1">
							<span class="fs-12 ">Exportar</span>
							<i class="fa fa-angle-down fs-14 " />
						</div>
					</p:commandLink>
					
					<p:menu overlay="true" trigger="cmdGlobalExcel" my="left top" at="left bottom" style="width:250px !important;">
						<p:menuitem value="Exportar excel" icon="fa-regular fa-file-excel fs-12" ajax="false">
							<p:fileDownload value="#{cuentaPagarCtrl.fileResumen}" contentDisposition="inline"/>
						</p:menuitem>
						<p:menuitem value="Exportar excel(detalle)" icon="fa fa-list fs-12" ajax="false">
							<p:fileDownload value="#{cuentaPagarCtrl.fileDetalle}" contentDisposition="inline"/>
						</p:menuitem>
					</p:menu>
				</div>
			
		    	<p:dataTable id="pvUnoDT"
		       			scrollable="true"
		       			value="#{cuentaPagarCtrl.vComprobantespagarcreditoList}"
		       			var="v"
		       			emptyMessage="#{msg['mensaje.noexistenDatos']}"
						styleClass="pvUnoDT fs-11 mt-1"
		                paginator="true"
		                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
		                currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
		                paginatorPosition="bottom"  
						rowKey="#{v.idcabecera}"
						rows="20"
						rowsPerPageTemplate="10,15,20,25,30,35,40">
					
					<p:column headerText="Opc" style="width:2.5rem;">
					
						<p:commandLink id="cmlDtFacEmitidas">
							<i class="fa fa-chevron-circle-down fs-18 text-gray-800" />
						</p:commandLink>
						
						<p:menu overlay="true" trigger="cmlDtFacEmitidas" my="left top" at="left bottom">
							<p:menuitem value=" Valor a pagar" action="#{porPagarCtrl.cargar()}" icon="fa fa-edit fs-14">
								<f:setPropertyActionListener value="MAIN_POR_PAGAR" target="#{porPagarCtrl.callModule}"/>
								<f:setPropertyActionListener value="#{cuentaPagarCtrl}" target="#{porPagarCtrl.cuentaPagarCtrl}"/>
								<f:setPropertyActionListener value="#{v.idcabecera}" target="#{porPagarCtrl.idAdquisicionSelected}"/>
								<f:setPropertyActionListener value="formMain" target="#{porPagarCtrl.callForm}"/>
								<f:setPropertyActionListener value=":formMain" target="#{porPagarCtrl.viewUpdate}"/>
								<f:setPropertyActionListener value="#{null}" target="#{porPagarCtrl.pagoCtrl}"/>
							</p:menuitem>
							
							<p:menuitem value=" Detalle de pagos" action="#{pagoCtrl.cargarPagosForm()}" process="@this" icon="fa fa-external-link fs-12">
								<f:setPropertyActionListener value="CUENTAS_PAGAR" target="#{pagoCtrl.callModule}"/>
								<f:setPropertyActionListener value="#{v.valorapagar}" target="#{pagoCtrl.valorPagar}"/>
								<f:setPropertyActionListener value="#{v.idcabecera}" target="#{pagoCtrl.idComprobante}"/>
								<f:setPropertyActionListener value="#{cuentaPagarCtrl}" target="#{pagoCtrl.cuentaPagarCtrl}"/>
								<f:setPropertyActionListener value="#{v.idtipocomprobante}" target="#{pagoCtrl.idTipoComprobante}"/>
							</p:menuitem>
							
							
						</p:menu>
						
					</p:column>	
					
					<p:column headerText="Comprobante" style="width:180px;" filterBy="#{v.filtroComprobante}" filterMatchMode="contains">
						<div class="flex flex-column gap-1">
							<h:outputText value="#{v.comprobante}" styleClass="text-gray-700"/>
							<div class="flex justify-content-between">
								<h:outputText value="#{compFacCtrl.getFormatoNumDocumento(v.numdocumento)}" styleClass="text-gray-700 font-medium Fs11">
								</h:outputText>
								<h:outputText value="#{v.fechaemision}" >
									<f:convertDateTime pattern="dd/MM/yyyy"/>
								</h:outputText>
								
							</div>
						</div>
					</p:column>
					
					
					<p:column headerText="Proveedor" style="width:20rem;" filterBy="#{v.filtroProveedor}" filterMatchMode="contains">
						<div class="flex flex-column gap-1">
							<h:outputText value="#{v.identificacion}" styleClass="text-gray-900">
							</h:outputText>
							<h:outputText value="#{v.razonsocial}" styleClass="uppercase text-primary-600 fw-3">
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="#{msg['label.credito']}" style="width:150px;">
						<div class="flex justify-content-between align-items-end mb-1">
							<span class="text-gray-800 fw-5">Total con impuestos</span>
							<h:outputText value="#{v.totalconimpuestos}" styleClass="text-gray-800 fw-5">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
						<div class="flex justify-content-between align-items-end mb-1">
							<span class="text-gray-900">Retención</span>
							<h:outputText value="#{v.totalretencion}" styleClass="text-gray-900">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
						<div class="flex justify-content-between align-items-end mb-1">
							<span class="text-gray-900">Otros pagos</span>
							<h:outputText value="#{v.totalOtrosPagos}" styleClass="text-gray-900">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
						<div class="flex justify-content-between align-items-end">
							<span class="text-primary-600 fw-5">Total crédito</span>
							<h:outputText value="#{v.totalpago}" styleClass="text-primary-600 fw-5">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>	
					
					<p:column headerText="Abono" style="width:80px;" styleClass="text-center">
						<div class="flex justify-content-end">
							<h:outputText value="#{v.abono}" styleClass="#{v.abono>0?'text-gray-900 ':' opacity-60'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="Saldo" style="width:80px;" styleClass="text-center">
						<div class="flex justify-content-end">
							<h:outputText value="#{v.totalpago-v.abono}" 
								styleClass="#{(v.totalpago-v.abono) > 0 and cuentaCobrarCtrl.isFechaVencida(v.fechapago) ? ' text-pink-400':' text-gray-900'}">
								<f:convertNumber pattern="#{appSessionCtrl.formatoMoneda}"/>
							</h:outputText>
						</div>
					</p:column>
					
					<p:column headerText="Vencimiento" style="width:100px;" styleClass="text-center">					
						<div class="flex flex-inline justify-content-end gap-1">
							<h:outputText value="#{v.fechapago}" 
								styleClass="fs-12 #{cuentaPagarCtrl.isFechaVencida(v.fechapago) ? 'ui-tag ui-widget ui-tag-danger' : ''}" style="width:75px;">
								<f:convertDateTime pattern="dd/MM/yyyy"/>
							</h:outputText>							
							<p:commandLink action="#{pagoCtrl.cargarPagosForm()}" process="@this" styleClass="text-gray-900">
								<i class="fa fa-external-link fs-14"/>
								<f:setPropertyActionListener value="CUENTAS_PAGAR" target="#{pagoCtrl.callModule}"/>
								<f:setPropertyActionListener value="#{v.valorapagar}" target="#{pagoCtrl.valorPagar}"/>
								<f:setPropertyActionListener value="#{v.idcabecera}" target="#{pagoCtrl.idComprobante}"/>
								<f:setPropertyActionListener value="#{cuentaPagarCtrl}" target="#{pagoCtrl.cuentaPagarCtrl}"/>
								<f:setPropertyActionListener value="#{v.idtipocomprobante}" target="#{pagoCtrl.idTipoComprobante}"/>
							</p:commandLink>
						</div>							
					</p:column>
						
				</p:dataTable>
				
			</div>
	    	
	    </h:form>
	    <!-- Formulario de pagos -->
	    <ui:include src="incl_pagos_list_form.xhtml"></ui:include>
	    
	    <ui:include src="incl_pagos_form.xhtml"></ui:include>
	    
	    <!-- Form Lista cliente -->
	    <ui:include src="../herramientas/incl_listaCliente.xhtml" />
	    
	    <!-- Form Cliente -->
	    <ui:include src="../herramientas/incl_cliente_form.xhtml" />
	    
	    <!-- Formulario del valor a pagar del comprobante -->
	    <ui:include src="../common/incl_porpagar_form.xhtml"></ui:include>
	    
    </ui:define>

</ui:composition>
