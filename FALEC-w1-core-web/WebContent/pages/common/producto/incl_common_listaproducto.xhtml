<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:o="http://omnifaces.org/ui"
				xmlns:of="http://omnifaces.org/functions"
				xmlns:pe="http://primefaces.org/ui/extensions">
	
	<style type="text/css">
		
		.heightFrmListProducto {			
			height: 450px;
		}
		
		.highlight-producto:hover {
			background-color: #E3F2FD85;
		}
		
		.product-image-busqueda {
			max-width: 7rem;
			max-height: 7rem;
			object-fit: cover;
			object-position: center top;
			margin: .3rem;
		}
		
	</style>	
	
	
	<p:dialog 
		header="Productos" 
		widgetVar="dlgListaProducto" 
		modal="true" 
		responsive="true" 
		width="99%"
		style="max-width:60rem;" 
		closeOnEscape="true" 
		styleClass="modalResponsivo">
		
		<h:form id="frmListProducto">
			<!-- <p:focus for=":frmListProducto:intListProBusqueda"/> -->			
			<p:remoteCommand name="buscarProducto" action="#{listaProductoCtrl.refrescar()}" update="@form" process="@this :frmListProducto:intListProBusqueda"/>
			
			<div class="flex mb-1">
				<div class="flex-none flex min-width-70">
					<p:selectOneMenu id="somLPTipoRegistro" styleClass="w-full"   tabindex="2" value="#{listaProductoCtrl.tipoRegistro}">
						<f:selectItem itemLabel="Producto" itemValue="1"/>
						<f:selectItem itemLabel="Otro Concepto" itemValue="2"/>
						<p:ajax event="change" update="@form" listener="#{listaProductoCtrl.cambioTipoRegistro()}" process="@this :frmListProducto:somLPTipoRegistro"/>
					</p:selectOneMenu>
				</div>
				<div class="flex-grow-1 flex px-1">
					<p:inputText id="intListProBusqueda" value="#{listaProductoCtrl.criterioBusqueda}" styleClass="w-full" tabindex="0" onkeydown="if(event.keyCode==13){event.keyCode=123;buscarProducto(); return false;}" disabled="#{listaProductoCtrl.tipoRegistro==2}"></p:inputText>
				</div>
				<div class="flex-none flex flex-row" style="width:63px!important;">
					<p:commandButton styleClass="ui-button-success mr-1" icon="fa fa-search" tabindex="1" action="#{listaProductoCtrl.refrescar()}" update="@form" process="@this :frmListProducto:intListProBusqueda" disabled="#{listaProductoCtrl.tipoRegistro==2}"/>					
   					<p:commandButton styleClass="ui-button-outlined" icon="fa fa-plus" disabled="#{listaProductoCtrl.tipoRegistro==2}" action="#{productoCtrl.nuevo()}" process="@this" update="@form">
   						<f:setPropertyActionListener value="ADQUISICION" target="#{productoCtrl.callModule}"/>
						<f:setPropertyActionListener value="#{listaProductoCtrl.establecimientoMain}" target="#{productoCtrl.establecimientoMain}"/>
						<!-- <f:setPropertyActionListener value="#{adquisicionFrmCtrl}" target="#{productoCtrl.adquisicionFrmCtrl}"/> -->
						<f:setPropertyActionListener value="frmListProducto" target="#{productoCtrl.formModule}"/>
						<f:setPropertyActionListener value=":frmListProducto" target="#{productoCtrl.viewUpdate}"/>
						<f:setPropertyActionListener value="#{listaProductoCtrl}" target="#{productoCtrl.listaProductoCtrl}"/>
   					</p:commandButton>	           					
				</div>
			</div>
			
			<p:tabView activeIndex="#{listaProductoCtrl.tabIndex}" id="tvPLmain">
				<p:ajax event="tabChange" listener="#{listaProductoCtrl.onTabChange}"/>
            	<p:tab title="Selección" id="tabLP_0" titleStyleClass="fs-14">
            	
            		<f:subview rendered="#{listaProductoCtrl.callModule=='ADQUISICION'}" id="fsvAdquisicion">
            			<ui:include src="../../common/producto/incl_common_listaproducto_formcompra.xhtml" />
            		</f:subview>
            		<f:subview rendered="#{listaProductoCtrl.callModule=='FACTURA'}" id="fsvFactura">
            			<ui:include src="../../common/producto/incl_common_listaproducto_formfactura.xhtml" />
            		</f:subview>
            		<f:subview rendered="#{listaProductoCtrl.callModule=='NOTA_CREDITO'}" id="fsvNCredito">
            			<ui:include src="../../common/producto/incl_common_listaproducto_formNotaCredito.xhtml" />
            		</f:subview>            	
            		<f:subview rendered="#{listaProductoCtrl.callModule=='LIQ_COMPRA'}" id="fsvLQCompra">
            			<ui:include src="../../common/producto/incl_common_listaproducto_formLiqCompra.xhtml" />
            		</f:subview>
            		<f:subview rendered="#{listaProductoCtrl.callModule=='COTIZACION'}" id="fsvCotizacion">
            			<ui:include src="../../common/producto/incl_common_listaproducto_formcotizacion.xhtml" />
            		</f:subview>
            	</p:tab>
            	<p:tab title="Búsqueda" id="tabLP_1" titleStyleClass="fs-14">
            		<p:outputPanel id="opuPLLista" styleClass="w-full">
	           			<div class="flex flex-row gap-2">
	           				<div class="flex-grow-1">
	           					<p:selectOneMenu id="somPLProductoCategoria"
									value="#{listaProductoCtrl.categoriaSelected}"
									converter="omnifaces.SelectItemsConverter"
									required="false"
									requiredMessage="REQUERIDO"
									styleClass="w-full"
									filter="true" filterMatchMode="contains"
									disabled="#{listaProductoCtrl.tipoRegistro==2}">
									<f:selectItem itemLabel="#{msg['label.seleccionar']} ..."
											itemValue="#{null}" value="#{null}" noSelectionOption="true" />
			
									<f:selectItems value="#{listaProductoCtrl.categoriaList}" var="c"
										itemLabel="#{c.categoria}" itemValue="#{c}" />
								</p:selectOneMenu>							
	           				</div>
	           				<div class="flex-grow-0 flex justify-content-center">
	           					<p:commandButton icon="fa fa-search" styleClass="ui-button-outlined" action="#{listaProductoCtrl.refrescarCategoria}" process="@this frmListProducto:tvPLmain:somPLProductoCategoria" update=":frmListProducto:tvPLmain:opuPLLista" disabled="#{listaProductoCtrl.tipoRegistro==2}"/>
	           				</div>
	           			</div>
	           			<p:message for="somPLProductoCategoria" styleClass="block"/>
	            		<div class="w-full overflow-auto heightFrmImportIce heightFrmListProducto">
	            			
	            			<div class="flex mt-1" style="width:99.5%!important;">
	      						
	      						<f:subview rendered="#{empty listaProductoCtrl.productoList}">
	      							<span class="py-2 text-gray-900 font-semibold block w-full">No existen productos</span>
	      						</f:subview>
	      						
	      						<div class="grid w-full">
		      						<p:repeat var="lp" value="#{listaProductoCtrl.productoList}">
		      							<div class="col-12 mx-1 border-bottom-2 border-blue-100 highlight-producto">
		      								<div class="flex gap-2">
		      									<div class="flex-0 text-center" style="min-width:7rem;">
		      										<p:outputPanel rendered="#{lp.imagen==null}">
														<i class="fa fa-5x fa-image opacity-40 text-center" style="width: 7rem;height:7rem;"></i>
													</p:outputPanel>
													
													<p:outputPanel rendered="#{lp.imagen!=null}">
			      										<p:commandLink id="imageProduct">
				      										<p:graphicImage value="#{productoCtrl.getImageToStream(lp.imagen)}" 
																stream="false" 
																styleClass="product-image-busqueda"/>
			      										</p:commandLink>
			      										<p:overlayPanel for="imageProduct" showCloseIcon="true" >
												            <p:imageSwitch effect="fade">
											                    <p:graphicImage value="#{productoCtrl.getImageToStream(lp.imagen)}" stream="false"/>
												            </p:imageSwitch>
												        </p:overlayPanel>
													</p:outputPanel>
		      									</div>
				      							<p:commandLink action="#{listaProductoCtrl.seleccionarProducto()}" 
				      								styleClass="px-1 flex-1" 
				      								process="@this" 
				      								update="@form">
				      								<div class="flex w-full">
				      									<div class="flex-grow-1 flex flex-column pr-1">
				      										<span class="fs-12 font-medium" style="color:black;">#{lp.nombre}</span>
				      										<div>
					      										<span class="fs-10 mr-1 text-gray-700 fa fa-barcode"/>
					      										<span class="fs-10 mr-1 text-gray-900">#{lp.codigoprincipal}</span>
				      										</div>
				      										<div>
					      										<span class="fs-9 mr-1 text-gray-700">Tipo de venta</span>
					      										<span class="fs-10 mr-1 text-gray-900">#{lp.tipoventa==1?'UNIDAD':lp.tipoventa==2?'A GRANEL':'KIT'}</span>
				      										</div>
				      									</div>
				      									<div class="flex-grow-0 flex min-width-60 flex-column text-right pr-3">
				      										<span class="fs-10" style="color:black;">Stock</span>
				      										<span class="fs-14 text-blue-600 font-medium">
				      											<h:outputText value="#{lp.stock}" >
				      												<f:convertNumber pattern="#{lp.tipoventa==2?appSessionCtrl.formatoNumber:appSessionCtrl.formatoInteger}"/>
				      											</h:outputText>
				      										</span>
				      									</div>
				      								</div>
				      								<f:setPropertyActionListener value="#{lp}" target="#{listaProductoCtrl.productoSelected}"/>
				      							</p:commandLink>
		      								</div>
		      							</div>
		      						</p:repeat>
	      						</div>
	      						
	      					</div>
	            			
	            		</div>            		
            		</p:outputPanel>
            	</p:tab>
            </p:tabView>
			
		</h:form>
	
	</p:dialog>
	

</ui:composition>
